<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Â· CallApp</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="header-title">ðŸ‘¤ Profile</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="profile-container" id="profileContent">
            <div class="loading-spinner"></div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <script type="module">
        import { initializeSupabase } from './utils/supabase.js'
        import { getRelayTalkUser, syncUserToDatabase } from './utils/userSync.js'
        
        let supabase
        let currentUser
        
        async function initProfile() {
            try {
                // Get user from RelayTalk
                const relayUser = getRelayTalkUser()
                if (!relayUser) {
                    window.location.href = '/'
                    return
                }
                
                // Initialize Supabase
                supabase = await initializeSupabase()
                
                // Sync user
                currentUser = await syncUserToDatabase(supabase, relayUser)
                
                // Load profile
                loadProfile()
                
            } catch (error) {
                console.error('Profile error:', error)
            }
        }
        
        function loadProfile() {
            const initial = currentUser.username.charAt(0).toUpperCase()
            
            document.getElementById('profileContent').innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">
                        ${currentUser.avatar_url 
                            ? `<img src="${currentUser.avatar_url}" alt="${currentUser.username}">`
                            : `<span>${initial}</span>`
                        }
                    </div>
                    <h2 class="profile-name">${currentUser.username}</h2>
                    <p class="profile-email">${currentUser.email}</p>
                    
                    <div class="profile-stats">
                        <div class="stat">
                            <div class="stat-value" id="friendCount">0</div>
                            <div class="stat-label">Friends</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="callCount">0</div>
                            <div class="stat-label">Calls</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-menu">
                    <div class="menu-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy</span>
                    </div>
                    <div class="menu-item">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </div>
                    <div class="menu-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            `
            
            loadStats()
        }
        
        async function loadStats() {
            // Load friend count
            const { count: friendCount } = await supabase
                .from('friends')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', currentUser.id)
            
            document.getElementById('friendCount').textContent = friendCount || 0
            
            // Load call count
            const { count: callCount } = await supabase
                .from('calls')
                .select('*', { count: 'exact', head: true })
                .or(`caller_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
            
            document.getElementById('callCount').textContent = callCount || 0
        }
        
        window.logout = async function() {
            await supabase
                .from('profiles')
                .update({ status: 'offline', last_seen: new Date().toISOString() })
                .eq('id', currentUser.id)
            
            // Clear RelayTalk storage? No - just redirect
            window.location.href = '/'
        }
        
        initProfile()
    </script>
</body>
</html>