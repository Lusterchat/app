<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #status {
            padding: 20px;
            background: #333;
            margin: 10px;
            border-radius: 8px;
        }
        #roomInfo {
            padding: 20px;
            background: #2a2a2a;
            margin: 10px;
            border-radius: 8px;
            word-break: break-all;
        }
        button {
            padding: 15px 30px;
            margin: 10px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #005a9e;
        }
        #dailyFrame {
            flex: 1;
            background: #000;
            margin: 10px;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="status">üîç Initializing call page...</div>
    <div id="roomInfo">Waiting for room URL...</div>
    <div id="dailyFrame" style="display: none;"></div>
    
    <div style="display: flex; justify-content: center;">
        <button onclick="goBack()">‚Üê Back to Friends</button>
    </div>

    <script>
        // ===== STEP 1: GET ROOM URL =====
        console.log('üöÄ CALL PAGE STARTED');
        
        const urlParams = new URLSearchParams(window.location.search);
        let roomUrl = urlParams.get('room');
        
        const roomInfo = document.getElementById('roomInfo');
        const statusDiv = document.getElementById('status');
        
        // Show what we got
        roomInfo.innerHTML = `
            <strong>Room URL:</strong> ${roomUrl || '‚ùå NOT FOUND!'}<br>
            <strong>Full URL:</strong> ${window.location.href}<br>
            <strong>Time:</strong> ${new Date().toLocaleTimeString()}
        `;
        
        // ===== STEP 2: CHECK IF WE HAVE ROOM URL =====
        if (!roomUrl) {
            statusDiv.innerHTML = '‚ùå ERROR: No room URL provided!';
            roomInfo.style.background = '#442222';
            throw new Error('No room URL');
        }
        
        statusDiv.innerHTML = '‚úÖ Room URL found! Loading Daily.co...';
        
        // ===== STEP 3: LOAD DAILY.CO =====
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@daily-co/daily-js';
        script.onload = function() {
            statusDiv.innerHTML = '‚úÖ Daily.co loaded! Creating call...';
            startCall();
        };
        script.onerror = function() {
            statusDiv.innerHTML = '‚ùå Failed to load Daily.co';
        };
        document.head.appendChild(script);
        
        // ===== STEP 4: START CALL =====
        function startCall() {
            try {
                statusDiv.innerHTML = 'üîß Creating call frame...';
                
                // Hide status, show video
                document.getElementById('status').style.display = 'none';
                document.getElementById('roomInfo').style.display = 'none';
                document.getElementById('dailyFrame').style.display = 'block';
                
                // Create call
                const callFrame = window.DailyIframe.createFrame(
                    document.getElementById('dailyFrame'),
                    {
                        showLeaveButton: true,
                        iframeStyle: {
                            width: '100%',
                            height: '100%',
                            border: '0'
                        }
                    }
                );
                
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = 'üîå Joining call...';
                
                callFrame.join({
                    url: roomUrl,
                    userName: 'User'
                });
                
                callFrame.on('joined-meeting', () => {
                    statusDiv.style.display = 'none';
                });
                
                callFrame.on('left-meeting', () => {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = 'üëã Call ended';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('roomInfo').innerHTML = 'Call ended. Click Back to return to friends.';
                });
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Error: ' + error.message;
            }
        }
        
        // ===== STEP 5: BACK BUTTON =====
        function goBack() {
            console.log('üîô Going back to friends');
            window.location.href = '/pages/home/friends/index.html';
        }
        
        // Log every second to prove no redirect
        let counter = 0;
        setInterval(() => {
            counter++;
            console.log(`‚è±Ô∏è Still on call page (${counter}s) - Room: ${roomUrl ? '‚úÖ' : '‚ùå'}`);
        }, 1000);
    </script>
</body>
</html>