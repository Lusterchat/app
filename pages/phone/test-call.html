<!DOCTYPE html>
<html>
<head>
    <title>Test Call</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            padding: 12px 24px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            min-height: 60px;
            border-left: 4px solid #4CAF50;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ§ Test Speaker Toggle</h1>
    
    <div>
        <button id="startBtn">Start Call</button>
        <button id="speakerBtn">Toggle Speaker</button>
        <button id="muteBtn">Toggle Mute</button>
        <button id="endBtn">End Call</button>
    </div>
    
    <div id="status">Ready to test...</div>
    
    <div class="log" id="log"></div>
    
    <script type="module">
        import callService from '/app/utils/callService.js';
        
        // Get DOM elements
        const startBtn = document.getElementById('startBtn');
        const speakerBtn = document.getElementById('speakerBtn');
        const muteBtn = document.getElementById('muteBtn');
        const endBtn = document.getElementById('endBtn');
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        
        // Log function
        function log(message) {
            console.log(message);
            logEl.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Initialize
        let isCallActive = false;
        
        // Update button states
        function updateButtons() {
            speakerBtn.disabled = !isCallActive;
            muteBtn.disabled = !isCallActive;
            endBtn.disabled = !isCallActive;
        }
        
        updateButtons();
        
        // Start Call
        startBtn.addEventListener('click', async () => {
            try {
                statusEl.textContent = 'Starting call...';
                log('ðŸš€ Initializing call service...');
                
                // Initialize with test user
                await callService.initialize('test-user-' + Date.now());
                log('âœ… Call service initialized');
                
                // Start call
                log('ðŸ“ž Initiating call...');
                const call = await callService.initiateCall('test-friend-' + Date.now(), 'voice');
                
                statusEl.textContent = `Call started! ID: ${call.id}`;
                log(`âœ… Call created: ${call.id}`);
                log(`ðŸ’¾ Check database: SELECT * FROM calls WHERE id = '${call.id}';`);
                
                // Setup callbacks
                callService.setOnSpeakerModeChange((mode) => {
                    log(`ðŸ”Š Speaker mode changed: ${mode ? 'SPEAKER' : 'MICROPHONE'}`);
                    statusEl.textContent = `Speaker: ${mode ? 'ON ðŸ”Š' : 'OFF ðŸŽ¤'}`;
                });
                
                callService.setOnCallStateChange((state) => {
                    log(`ðŸ“Š Call state: ${state}`);
                });
                
                callService.setOnRemoteStream((stream) => {
                    log('ðŸ”Š Remote stream received');
                });
                
                callService.setOnCallEvent((event, data) => {
                    log(`ðŸ“ž Call event: ${event}`, data);
                });
                
                isCallActive = true;
                updateButtons();
                log('ðŸŽ‰ Call is active! Try toggling speaker...');
                
            } catch (error) {
                statusEl.textContent = `Error: ${error.message}`;
                log(`âŒ Error: ${error.message}`);
                console.error(error);
            }
        });
        
        // Toggle Speaker
        speakerBtn.addEventListener('click', async () => {
            try {
                log('ðŸ”„ Toggling speaker mode...');
                const newMode = await callService.toggleSpeakerMode();
                
                log(`âœ… Speaker toggled to: ${newMode ? 'SPEAKER ðŸ”Š' : 'MICROPHONE ðŸŽ¤'}`);
                statusEl.textContent = `Speaker: ${newMode ? 'ON ðŸ”Š' : 'OFF ðŸŽ¤'}`;
                
                // Check database
                log(`ðŸ’¾ Database should show: audio_mode = '${newMode ? 'speaker' : 'mic'}'`);
                log(`Run: SELECT audio_mode, updated_at FROM calls ORDER BY updated_at DESC LIMIT 1;`);
                
            } catch (error) {
                log(`âŒ Toggle failed: ${error.message}`);
                console.error(error);
            }
        });
        
        // Toggle Mute
        muteBtn.addEventListener('click', async () => {
            try {
                const muted = await callService.toggleMute();
                log(`ðŸŽ¤ Microphone ${muted ? 'MUTED ðŸ”‡' : 'UNMUTED ðŸŽ¤'}`);
                statusEl.textContent = `Mic: ${muted ? 'MUTED ðŸ”‡' : 'UNMUTED ðŸŽ¤'}`;
            } catch (error) {
                log(`âŒ Mute failed: ${error.message}`);
                console.error(error);
            }
        });
        
        // End Call
        endBtn.addEventListener('click', async () => {
            try {
                log('ðŸ“ž Ending call...');
                await callService.endCall();
                
                statusEl.textContent = 'Call ended';
                log('âœ… Call ended');
                
                isCallActive = false;
                updateButtons();
                
            } catch (error) {
                log(`âŒ End call failed: ${error.message}`);
                console.error(error);
            }
        });
        
        // Make functions available globally for debugging
        window.startTestCall = () => startBtn.click();
        window.toggleTestSpeaker = () => speakerBtn.click();
        window.toggleTestMute = () => muteBtn.click();
        window.endTestCall = () => endBtn.click();
        
        log('âœ… Test page loaded. Click "Start Call" to begin.');
        
    </script>
    
    <!-- Debug section -->
    <script>
        // Console debugging helpers
        console.log('ðŸ”§ Debug helpers available:');
        console.log('- window.startTestCall() - Start a test call');
        console.log('- window.toggleTestSpeaker() - Toggle speaker');
        console.log('- window.toggleTestMute() - Toggle mute');
        console.log('- window.endTestCall() - End call');
        
        // Quick database check helper
        window.checkDB = function() {
            console.log('ðŸ“Š Database check SQL:');
            console.log(`1. Latest call: SELECT id, status, audio_mode FROM calls ORDER BY created_at DESC LIMIT 1;`);
            console.log(`2. All calls: SELECT id, status, audio_mode, created_at FROM calls ORDER BY created_at DESC LIMIT 10;`);
            console.log(`3. Speaker toggles: SELECT id, audio_mode, updated_at FROM calls WHERE audio_mode = 'speaker' ORDER BY updated_at DESC;`);
        };
    </script>
</body>
</html>