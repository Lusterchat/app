<!DOCTYPE html>
<html>
<head>
    <title>üîß Test Call - Speaker Toggle Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: #333;
            margin-top: 0;
        }
        
        button {
            padding: 12px 24px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .primary-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .secondary-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        .danger-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        
        .warning-btn {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #status {
            margin: 20px 0;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            min-height: 60px;
            border-left: 5px solid #4CAF50;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .status-speaker {
            border-left-color: #2196F3;
            background: #e3f2fd;
        }
        
        .status-error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .log {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-info { color: #2196F3; }
        .log-warning { color: #ff9800; }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .db-query {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            display: none;
        }
        
        .test-pass {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            display: block;
        }
        
        .test-fail {
            background: #ffebee;
            border-left: 4px solid #f44336;
            display: block;
        }
        
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .speaker-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .speaker-on {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .speaker-off {
            background: #f5f5f5;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-section">
        <h1>üîß Speaker Toggle Debug Test</h1>
        <p>This page tests if speaker toggle correctly updates the database.</p>
    </div>

    <div class="test-section">
        <h2>üìû Call Controls</h2>
        <div class="controls-grid">
            <button id="startBtn" class="primary-btn">Start Test Call</button>
            <button id="speakerBtn" class="secondary-btn" disabled>Toggle Speaker</button>
            <button id="muteBtn" class="warning-btn" disabled>Toggle Mute</button>
            <button id="endBtn" class="danger-btn" disabled>End Call</button>
            <button id="checkDB" class="secondary-btn">Check Database</button>
        </div>
    </div>

    <div class="test-section">
        <h2>üìä Status</h2>
        <div id="status">Ready to test. Click "Start Test Call" to begin.</div>
        
        <div id="speakerIndicator" class="speaker-indicator speaker-off">
            <span>üîá</span>
            <span>Speaker Mode: NOT SET</span>
        </div>
        
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>üìù Live Log</h2>
        <div class="log" id="log"></div>
    </div>

    <div class="test-section debug-section">
        <h2>üîç Database Debug</h2>
        <div class="db-query">
            <strong>Latest call check:</strong><br>
            SELECT id, status, audio_mode, updated_at <br>
            FROM calls <br>
            ORDER BY created_at DESC LIMIT 1;
        </div>
        
        <div class="db-query">
            <strong>Check speaker toggles:</strong><br>
            SELECT id, audio_mode, updated_at <br>
            FROM calls <br>
            WHERE audio_mode = 'speaker' <br>
            ORDER BY updated_at DESC LIMIT 5;
        </div>
        
        <button onclick="showAllQueries()" class="secondary-btn">Show All SQL Queries</button>
        <div id="allQueries" style="display: none; margin-top: 15px;"></div>
    </div>

    <script type="module">
        // Import callService
        let callService;
        import('/app/utils/callService.js').then(module => {
            callService = module.default;
            log('‚úÖ CallService loaded', 'success');
        }).catch(error => {
            log('‚ùå Failed to load CallService: ' + error.message, 'error');
        });

        // Get DOM elements
        const startBtn = document.getElementById('startBtn');
        const speakerBtn = document.getElementById('speakerBtn');
        const muteBtn = document.getElementById('muteBtn');
        const endBtn = document.getElementById('endBtn');
        const checkDBBtn = document.getElementById('checkDB');
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const speakerIndicator = document.getElementById('speakerIndicator');
        const testResults = document.getElementById('testResults');

        // State
        let isCallActive = false;
        let currentCallId = null;
        let speakerMode = false;
        let testStep = 0;

        // Log function with colors
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `log-${type}`;
            const logEntry = `<span class="${typeClass}">${timestamp} - ${message}</span><br>`;
            
            logEl.innerHTML += logEntry;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Update button states
        function updateButtons() {
            speakerBtn.disabled = !isCallActive;
            muteBtn.disabled = !isCallActive;
            endBtn.disabled = !isCallActive;
            checkDBBtn.disabled = !currentCallId;
        }

        // Update speaker indicator
        function updateSpeakerIndicator(mode) {
            speakerMode = mode;
            if (mode) {
                speakerIndicator.className = 'speaker-indicator speaker-on';
                speakerIndicator.innerHTML = '<span>üîä</span><span>Speaker Mode: ON (LOUDSPEAKER)</span>';
            } else {
                speakerIndicator.className = 'speaker-indicator speaker-off';
                speakerIndicator.innerHTML = '<span>üéß</span><span>Speaker Mode: OFF (EARPIECE)</span>';
            }
        }

        // Update status
        function updateStatus(message, type = 'normal') {
            statusEl.textContent = message;
            statusEl.className = '';
            
            if (type === 'speaker') {
                statusEl.classList.add('status-speaker');
            } else if (type === 'error') {
                statusEl.classList.add('status-error');
            }
        }

        // Add test result
        function addTestResult(passed, message) {
            testStep++;
            const resultClass = passed ? 'test-pass' : 'test-fail';
            const icon = passed ? '‚úÖ' : '‚ùå';
            testResults.innerHTML += `
                <div class="test-result ${resultClass}">
                    <strong>Test ${testStep}:</strong> ${icon} ${message}
                </div>
            `;
        }

        // Start Call
        startBtn.addEventListener('click', async () => {
            try {
                log('üöÄ Starting test call...', 'info');
                updateStatus('Initializing test call...');
                
                // Initialize with test user
                await callService.initialize('test-user-' + Date.now());
                log('‚úÖ CallService initialized', 'success');
                
                addTestResult(true, 'CallService initialized');

                // Start call
                log('üìû Creating test call...', 'info');
                const call = await callService.initiateCall('test-friend-' + Date.now(), 'voice');
                
                currentCallId = call.id;
                log(`‚úÖ Call created with ID: ${call.id}`, 'success');
                log(`üíæ Initial audio_mode: ${call.audio_mode}`, 'info');
                
                addTestResult(true, `Call created (ID: ${call.id.substring(0, 8)}...)`);

                // Setup callbacks
                callService.setOnSpeakerModeChange((mode) => {
                    log(`üîä Speaker mode callback: ${mode ? 'SPEAKER' : 'MIC'}`, 'info');
                    updateSpeakerIndicator(mode);
                    updateStatus(`Speaker mode: ${mode ? 'ON üîä' : 'OFF üé§'}`, 'speaker');
                });

                callService.setOnCallStateChange((state) => {
                    log(`üìä Call state: ${state}`, 'info');
                });

                callService.setOnRemoteStream(() => {
                    log('üîä Remote stream received (simulated)', 'success');
                });

                callService.setOnCallEvent((event, data) => {
                    log(`üìû Call event: ${event} ${JSON.stringify(data)}`, 'info');
                });

                // Initial state
                isCallActive = true;
                updateButtons();
                updateStatus(`Call active! Current audio_mode: ${call.audio_mode}`);
                updateSpeakerIndicator(call.audio_mode === 'speaker');
                
                log('üéâ Test call ready! You can now toggle speaker.', 'success');
                addTestResult(true, 'Call setup complete');

                // Auto-test: Toggle speaker once after 2 seconds
                setTimeout(async () => {
                    log('üîÑ Auto-test: Toggling speaker...', 'warning');
                    await speakerBtn.click();
                }, 2000);

            } catch (error) {
                log(`‚ùå Error starting call: ${error.message}`, 'error');
                updateStatus(`Error: ${error.message}`, 'error');
                console.error(error);
                addTestResult(false, `Failed to start call: ${error.message}`);
            }
        });

        // Toggle Speaker
        speakerBtn.addEventListener('click', async () => {
            try {
                log('üîÑ Toggling speaker mode...', 'info');
                const startTime = Date.now();
                
                const newMode = await callService.toggleSpeakerMode();
                
                const toggleTime = Date.now() - startTime;
                log(`‚úÖ Toggled to: ${newMode ? 'SPEAKER üîä' : 'MICROPHONE üé§'} (${toggleTime}ms)`, 'success');
                
                updateSpeakerIndicator(newMode);
                updateStatus(`Speaker: ${newMode ? 'ON üîä' : 'OFF üé§'}`, 'speaker');
                
                // Check database after toggle
                log('üíæ Checking database update...', 'info');
                setTimeout(async () => {
                    await checkDatabase();
                }, 500);
                
            } catch (error) {
                log(`‚ùå Toggle failed: ${error.message}`, 'error');
                console.error(error);
            }
        });

        // Toggle Mute
        muteBtn.addEventListener('click', async () => {
            try {
                const muted = await callService.toggleMute();
                log(`üé§ Microphone ${muted ? 'MUTED üîá' : 'UNMUTED üé§'}`, 'info');
                updateStatus(`Mic: ${muted ? 'MUTED üîá' : 'UNMUTED üé§'}`);
            } catch (error) {
                log(`‚ùå Mute failed: ${error.message}`, 'error');
            }
        });

        // End Call
        endBtn.addEventListener('click', async () => {
            try {
                log('üìû Ending call...', 'info');
                await callService.endCall();
                
                log('‚úÖ Call ended', 'success');
                updateStatus('Call ended');
                
                isCallActive = false;
                currentCallId = null;
                updateButtons();
                
                // Show final test results
                addTestResult(true, 'Call ended cleanly');
                
            } catch (error) {
                log(`‚ùå End call failed: ${error.message}`, 'error');
            }
        });

        // Check Database
        checkDBBtn.addEventListener('click', async () => {
            await checkDatabase();
        });

        // Database check function
        async function checkDatabase() {
            if (!currentCallId) {
                log('‚ùå No active call to check', 'error');
                return;
            }
            
            try {
                log('üîç Querying database for call...', 'info');
                
                // We need to import supabase for direct database check
                const { supabase } = await import('/app/utils/supabase.js');
                
                const { data: call, error } = await supabase
                    .from('calls')
                    .select('id, status, audio_mode, updated_at, created_at')
                    .eq('id', currentCallId)
                    .single();
                    
                if (error) {
                    log(`‚ùå Database error: ${error.message}`, 'error');
                    addTestResult(false, `Database query failed: ${error.message}`);
                } else if (call) {
                    log(`‚úÖ Database record found:`, 'success');
                    log(`   ID: ${call.id}`, 'info');
                    log(`   Status: ${call.status}`, 'info');
                    log(`   Audio Mode: ${call.audio_mode}`, call.audio_mode === 'speaker' ? 'warning' : 'info');
                    log(`   Updated: ${new Date(call.updated_at).toLocaleTimeString()}`, 'info');
                    
                    // Check if database matches current state
                    const dbMatches = (call.audio_mode === 'speaker') === speakerMode;
                    
                    if (dbMatches) {
                        log(`‚úÖ DATABASE SYNC: OK - DB matches UI (${call.audio_mode})`, 'success');
                        addTestResult(true, `Database synchronized: ${call.audio_mode}`);
                    } else {
                        log(`‚ùå DATABASE SYNC: MISMATCH - DB: ${call.audio_mode}, UI: ${speakerMode ? 'speaker' : 'mic'}`, 'error');
                        addTestResult(false, `Database mismatch: DB=${call.audio_mode}, UI=${speakerMode ? 'speaker' : 'mic'}`);
                    }
                } else {
                    log('‚ùå No call found in database', 'error');
                    addTestResult(false, 'Call not found in database');
                }
                
            } catch (error) {
                log(`‚ùå Database check failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Make functions available globally
        window.startTestCall = () => startBtn.click();
        window.toggleTestSpeaker = () => speakerBtn.click();
        window.toggleTestMute = () => muteBtn.click();
        window.endTestCall = () => endBtn.click();
        window.checkDatabase = checkDatabase;
        window.getCallState = () => ({
            isCallActive,
            currentCallId,
            speakerMode,
            callService: callService ? 'loaded' : 'not loaded'
        });

        // Initial log
        log('‚úÖ Test page loaded. Click "Start Test Call" to begin.', 'success');
        updateButtons();

    </script>

    <!-- Debug console helpers -->
    <script>
        function showAllQueries() {
            const queries = `
            <div class="db-query">
                <strong>1. Latest call:</strong><br>
                SELECT id, status, audio_mode, updated_at, caller_id, receiver_id<br>
                FROM calls<br>
                ORDER BY created_at DESC LIMIT 1;
            </div>
            
            <div class="db-query">
                <strong>2. All recent calls:</strong><br>
                SELECT id, status, audio_mode, updated_at, created_at<br>
                FROM calls<br>
                ORDER BY created_at DESC LIMIT 10;
            </div>
            
            <div class="db-query">
                <strong>3. Speaker toggles:</strong><br>
                SELECT id, audio_mode, updated_at,<br>
                EXTRACT(EPOCH FROM (updated_at - created_at)) as seconds_since_creation<br>
                FROM calls<br>
                WHERE audio_mode = 'speaker'<br>
                ORDER BY updated_at DESC LIMIT 10;
            </div>
            
            <div class="db-query">
                <strong>4. Check for updates:</strong><br>
                SELECT id, audio_mode, updated_at,<br>
                CASE WHEN audio_mode = 'speaker' THEN 'LOUDSPEAKER' ELSE 'MICROPHONE' END as mode_description<br>
                FROM calls<br>
                WHERE updated_at > NOW() - INTERVAL '5 minutes'<br>
                ORDER BY updated_at DESC;
            </div>
            `;
            
            document.getElementById('allQueries').innerHTML = queries;
            document.getElementById('allQueries').style.display = 'block';
        }

        // Console helpers
        console.log('üîß DEBUG HELPERS:');
        console.log('‚Ä¢ window.startTestCall() - Start a test call');
        console.log('‚Ä¢ window.toggleTestSpeaker() - Toggle speaker mode');
        console.log('‚Ä¢ window.toggleTestMute() - Toggle mute');
        console.log('‚Ä¢ window.endTestCall() - End current call');
        console.log('‚Ä¢ window.checkDatabase() - Check database state');
        console.log('‚Ä¢ window.getCallState() - Get current call state');
        
        console.log('\nüìä DATABASE QUERIES:');
        console.log(`1. SELECT id, status, audio_mode FROM calls ORDER BY created_at DESC LIMIT 1;`);
        console.log(`2. SELECT COUNT(*) as total_calls, COUNT(CASE WHEN audio_mode = 'speaker' THEN 1 END) as speaker_calls FROM calls;`);
        console.log(`3. SELECT * FROM calls WHERE audio_mode = 'speaker' ORDER BY updated_at DESC LIMIT 5;`);
    </script>
</body>
</html>